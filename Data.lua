local ADDON, Addon = ...
local Data = Addon:NewModule('Data')

local KNOWLEDGE_CURRENCY_ID = 1171
local cachedItems = {}

local worldQuestReps = {[49413]={2159,2103},[49800]={2159,2103},[50459]={2159,2156},[50461]={2159,2156},[50468]={2159,2156},[50483]={2159,2156},[50488]={2159,2156},[50489]={2159,2156},[50490]={2159,2156},[50491]={2159,2156},[50492]={2159,2156},[50496]={2159,2156},[50498]={2159,2156},[50499]={2159,2156},[50501]={2159,2156},[50503]={2159,2156},[50505]={2159,2156},[50507]={2159,2156},[50509]={2159,2156},[50510]={2159,2156},[50512]={2159,2156},[50513]={2159,2156},[50514]={2159,2156},[50515]={2159,2156},[50517]={2159,2156},[50518]={2159,2156},[50519]={2159,2156},[50564]={2159,2156},[50566]={2159,2156},[50568]={2159,2156},[50845]={2159,2103},[50846]={2159,2103},[50847]={2159,2103},[50850]={2159,2103},[50853]={2159,2103},[50854]={2159,2103},[50857]={2159,2103},[50859]={2159,2103},[50861]={2159,2103},[50862]={2159,2103},[50863]={2159,2103},[50864]={2159,2103},[50866]={2159,2103},[50867]={2159,2103},[50868]={2159,2103},[50869]={2159,2103},[50870]={2159,2103},[50871]={2159,2103},[50873]={2159,2103},[50874]={2159,2103},[50875]={2159,2103},[50876]={2159,2103},[50877]={2159,2103},[50885]={2159,2103},[50975]={2164,2159,2158},[51064]={2164,2159,2156},[51081]={2159,2103},[51084]={2159,2103},[51095]={2159,2158},[51096]={2159,2158},[51097]={2159,2158},[51098]={2159,2158},[51099]={2159,2158},[51100]={2159,2158},[51102]={2159,2158},[51103]={2159,2158},[51104]={2159,2158},[51106]={2159,2158},[51108]={2159,2158},[51112]={2159,2158},[51113]={2159,2158},[51114]={2159,2158},[51115]={2159,2158},[51116]={2159,2158},[51117]={2159,2158},[51119]={2159,2158},[51120]={2159,2158},[51121]={2159,2158},[51122]={2159,2158},[51123]={2159,2158},[51153]={2159,2158},[51155]={2159,2158},[51156]={2159,2158},[51157]={2159,2158},[51175]={2164,2159,2103},[51179]={2164,2159,2103},[51185]={2164,2159,2158},[51212]={2161,2157},[51216]={2161,2157},[51297]={2160,2157},[51377]={2159,2158},[51378]={2159,2158},[51411]={2164,2159,2156},[51412]={2164,2159,2156},[51415]={2164,2159,2156},[51422]={2164,2159,2158},[51428]={2164,2159,2158},[51429]={2159,2158},[51431]={2161,2157},[51433]={2161,2157},[51434]={2161,2157},[51444]={2164,2159,2103},[51450]={2164,2159,2103},[51453]={2162,2157},[51457]={2161,2157},[51466]={2161,2157},[51467]={2161,2157},[51468]={2161,2157},[51469]={2161,2157},[51491]={2161,2157},[51505]={2161,2157},[51506]={2161,2157},[51507]={2161,2157},[51508]={2161,2157},[51512]={2161,2157},[51527]={2161,2157},[51528]={2161,2157},[51529]={2161,2157},[51541]={2161,2157},[51542]={2161,2157},[51581]={2164,2160,2157},[51583]={2164,2160,2157},[51584]={2164,2160,2157},[51586]={2164,2160,2157},[51608]={2164,2161,2157},[51609]={2164,2161,2157},[51610]={2160,2157},[51611]={2160,2157},[51612]={2164,2161,2157},[51613]={2160,2157},[51615]={2164,2161,2157},[51617]={2164,2162,2157},[51618]={2164,2162,2157},[51623]={2164,2162,2157},[51625]={2163,2161,2157},[51626]={2163,2160,2157},[51627]={2163,2162,2157},[51628]={2163,2159,2156},[51629]={2163,2159,2158},[51630]={2163,2159,2103},[51632]={2163,2160,2157},[51635]={2163,2159,2158},[51637]={2163,2161,2157},[51638]={2163,2160,2157},[51639]={2163,2162,2157},[51640]={2163,2159,2156},[51641]={2163,2159,2158},[51642]={2163,2159,2103},[51644]={2164,2162,2157},[51651]={2160,2157},[51653]={2160,2157},[51654]={2160,2157},[51655]={2160,2157},[51656]={2160,2157},[51657]={2160,2157},[51659]={2160,2157},[51661]={2160,2157},[51662]={2160,2157},[51664]={2160,2157},[51666]={2160,2157},[51669]={2160,2157},[51670]={2160,2157},[51699]={2161,2157},[51759]={2162,2157},[51774]={2162,2157},[51778]={2162,2157},[51779]={2162,2157},[51781]={2162,2157},[51782]={2162,2157},[51806]={2162,2157},[51839]={2160,2157},[51841]={2160,2157},[51842]={2160,2157},[51843]={2160,2157},[51844]={2160,2157},[51847]={2160,2157},[51848]={2160,2157},[51849]={2160,2157},[51856]={2159,2156},[51874]={2161,2157},[51884]={2161,2157},[51886]={2162,2157},[51887]={2161,2157},[51890]={2160,2157},[51891]={2160,2157},[51892]={2160,2157},[51893]={2160,2157},[51894]={2160,2157},[51895]={2160,2157},[51897]={2161,2157},[51901]={2162,2157},[51905]={2162,2157},[51906]={2161,2157},[51908]={2161,2157},[51909]={2161,2157},[51917]={2161,2157},[51920]={2161,2157},[51921]={2162,2157},[51970]={2161,2157},[51972]={2161,2157},[51976]={2162,2157},[51988]={2161,2157},[51989]={2161,2157},[52009]={2161,2157},[52126]={2162,2157},[52157]={2161,2157},[52165]={2162,2157},[52166]={2162,2157},[52181]={2159,2156},[52196]={2159,2158},[52218]={2161,2157},[52278]={2161,2157},[52295]={2159,2157},[52297]={2161,2157},[52299]={2162,2157},[52300]={2162,2157},[52301]={2162,2157},[52306]={2162,2157},[52309]={2162,2157},[52310]={2162,2157},[52316]={2162,2157},[52321]={2162,2157},[52322]={2162,2157},[52325]={2162,2157},[52328]={2162,2157},[52330]={2162,2157},[52344]=2163,[52352]={2162,2157},[52394]=2163,[52430]={2160,2157},[52446]={2162,2157},[52455]={2160,2157},[52458]={2160,2157},[52459]={2162,2157},[52463]={2162,2157},[52464]={2162,2157},[52471]={2160,2157},[52476]={2162,2157},[52751]={2160,2157},[52754]={2159,2156},[52779]={2159,2156},[52799]={2159,2156},[52803]={2159,2156},[52832]={2164,2159,2156},[52849]={2164,2159,2158},[52850]={2159,2158},[52856]={2159,2158},[52858]={2164,2159,2103},[52862]={2164,2161,2157},[52864]={2159,2158},[52869]={2164,2160,2157},[52871]={2164,2162,2157},[52872]={2164,2161,2157},[52873]={2164,2162,2157},[52874]={2164,2160,2157},[52875]={2164,2159,2158},[52877]={2164,2159,2103},[52878]={2159,2158},[52880]={2162,2157},[52884]={2164,2159,2156},[52889]={2162,2157},[52892]={2159,2103},[52923]={2159,2103},[52937]={2159,2103},[52938]={2159,2103},[53271]={2161,2157},[53280]={2160,2157},[53286]={2162,2157},[53289]={2159,2156},[53294]={2159,2156},[53296]={2159,2158},[53297]={2159,2158},[53300]={2159,2158},[53303]={2159,2103},[53311]={2161,2157},[53312]={2160,2157},[53314]={2160,2157},[53316]={2162,2157},[53317]={2162,2157},[53323]={2159,2156},[53324]={2159,2158},[53325]={2159,2158},[53326]={2159,2158},[53327]={2159,2103},[53329]={2159,2103},[49397]={2161,2157},[49994]={2160,2157},[50000]={2161,2157},[50164]={2160,2157},[50234]={2160,2157},[50295]={2160,2157},[50296]={2160,2157},[50299]={2160,2157},[50315]={2160,2157},[50322]={2160,2157},[50324]={2160,2157},[50369]={2161,2157},[50421]={2160,2157},[50527]={2159,2103},[50591]={2162,2157},[50651]={2159,2103},[50737]={2159,2103},[50756]={2159,2103},[50767]={2160,2157},[50776]={2160,2157},[50782]={2159,2103},[50792]={2160,2157},[50855]={2159,2103},[50858]={2159,2103},[50899]={2159,2156},[50936]={2159,2156},[50958]={2160,2157},[50961]={2159,2156},[50962]={2159,2156},[50969]={2159,2103},[50977]={2160,2157},[50982]={2162,2157},[50983]={2160,2157},[50984]={2160,2157},[50986]={2161,2157},[50987]={2161,2157},[50989]={2162,2157},[50991]={2161,2157},[50993]={2162,2157},[50994]={2161,2157},[50996]={2162,2157},[50998]={2160,2157},[51017]=2159,[51021]=2159,[51022]=2159,[51023]=2159,[51024]=2159,[51025]=2159,[51026]=2159,[51027]=2159,[51028]=2159,[51029]=2159,[51030]=2159,[51031]=2159,[51032]=2159,[51033]=2159,[51034]=2159,[51035]={2161,2157},[51092]={2160,2157},[51109]={2159,2156},[51127]={2159,2156},[51131]={2159,2156},[51154]={2159,2156},[51166]={2159,2156},[51172]={2159,2156},[51178]={2159,2103},[51225]={2160,2157},[51241]={2160,2157},[51245]={2160,2157},[51284]={2160,2157},[51311]={2160,2157},[51317]={2160,2157},[51373]={2159,2103},[51374]={2159,2103},[51385]={2160,2157},[51388]={2160,2157},[51397]={2161,2157},[51405]={2160,2157},[51406]={2160,2157},[51454]={2161,2157},[51530]={2161,2157},[51546]={2159,2156},[51548]={2159,2156},[51550]={2159,2156},[51562]={2159,2158},[51564]={2159,2158},[51565]={2159,2158},[51576]={2161,2157},[51577]={2160,2157},[51579]={2160,2157},[51585]={2161,2157},[51588]={2161,2157},[51604]={2161,2157},[51619]={2161,2157},[51620]={2161,2157},[51621]={2160,2157},[51658]={2161,2157},[51667]={2161,2157},[51672]={2161,2157},[51676]={2161,2157},[51681]={2161,2157},[51682]={2161,2157},[51683]={2161,2157},[51686]={2161,2157},[51687]={2161,2157},[51690]={2161,2157},[51693]={2161,2157},[51694]={2161,2157},[51697]={2161,2157},[51706]={2161,2157},[51707]={2161,2157},[51709]={2161,2157},[51710]={2161,2157},[51758]={2160,2157},[51760]={2159,2158},[51783]={2159,2158},[51793]={2159,2158},[51794]={2159,2158},[51804]={2159,2158},[51814]={2159,2103},[51815]={2159,2103},[51816]={2159,2103},[51817]={2162,2157},[51820]={2162,2157},[51821]={2159,2103},[51822]={2159,2103},[51824]={2159,2103},[51834]={2159,2158},[51836]={2159,2158},[51853]={2159,2158},[51854]={2162,2157},[51855]={2162,2157},[51925]={2159,2158},[51928]={2159,2158},[51931]={2159,2158},[51933]={2159,2158},[51963]={2159,2158},[51981]={2162,2157},[51995]={2159,2158},[52010]={2160,2157},[52011]={2162,2157},[52045]={2162,2157},[52047]={2160,2157},[52054]={2162,2157},[52059]={2159,2158},[52071]={2162,2157},[52120]={2160,2157},[52140]={2162,2157},[52142]={2162,2157},[52143]={2160,2157},[52144]={2160,2157},[52155]={2160,2157},[52159]={2160,2157},[52163]={2160,2157},[52164]={2162,2157},[52167]={2160,2157},[52168]={2162,2157},[52174]={2162,2157},[52179]={2162,2157},[52180]={2162,2157},[52200]={2162,2157},[52211]={2162,2157},[52230]={2162,2157},[52249]={2159,2103},[52250]={2159,2103},[52271]={2162,2157},[52331]=2159,[52333]={2160,2157},[52334]={2161,2157},[52339]=2159,[52340]=2159,[52353]={2162,2157},[52356]={2160,2157},[52357]={2161,2157},[52363]=2159,[52365]={2161,2157},[52367]={2162,2157},[52368]=2159,[52375]=2159,[52376]=2159,[52377]={2160,2157},[52378]=2159,[52379]=2159,[52390]={2161,2157},[52392]=2159,[52405]={2160,2157},[52407]={2161,2157},[52414]={2161,2157},[52415]={2162,2157},[52417]={2160,2157},[52423]={2160,2157},[52424]={2161,2157},[52761]={2160,2157},[52785]={2159,2156},[52794]={2162,2157},[52847]={2161,2157},[52865]={2162,2157},[52879]={2162,2157},[52891]={2162,2157},[52924]={2162,2157},[52935]={2162,2157},[52939]={2162,2157},[52941]={2162,2157},[52947]={2162,2157},[52964]={2162,2157},[52972]={2162,2157},[52979]={2162,2157},[52982]={2162,2157},[52987]={2162,2157},[52988]={2162,2157},[53012]={2162,2157},[53040]={2162,2157},[53106]={2162,2157},[53107]={2162,2157},[53108]={2162,2157},[53165]={2159,2103},[53188]={2160,2157},[53189]={2160,2157},[53331]=2160,[47704]={2159,2158},[49013]={2159,2158},[49068]={2159,2103},[49345]={2159,2158},[49444]={2159,2103},[50287]={2159,2103},[50443]={2159,2156},[50474]={2159,2156},[50497]={2159,2156},[50521]={2159,2156},[50524]={2159,2103},[50529]={2159,2156},[50540]={2159,2103},[50545]={2159,2156},[50547]={2159,2103},[50548]={2159,2103},[50549]={2159,2156},[50559]={2159,2156},[50571]={2159,2103},[50572]={2159,2156},[50574]={2159,2103},[50577]={2159,2156},[50578]={2159,2103},[50581]={2159,2103},[50587]={2159,2156},[50592]={2159,2103},[50619]={2159,2103},[50634]={2159,2156},[50636]={2159,2103},[50648]={2159,2156},[50650]={2159,2156},[50652]={2159,2103},[50660]={2159,2156},[50665]={2159,2156},[50676]={2159,2156},[50689]={2159,2156},[50695]={2159,2156},[50717]={2159,2156},[50718]={2159,2156},[50735]={2159,2156},[50744]={2159,2103},[50765]={2159,2103},[50786]={2159,2156},[50813]={2159,2156},[50964]={2159,2103},[50966]={2159,2103},[50999]={2159,2103},[51000]={2159,2103},[51003]={2159,2158},[51005]={2159,2156},[51006]={2159,2156},[51007]={2159,2158},[51008]={2159,2158},[51009]={2159,2156},[51010]={2159,2103},[51013]={2159,2103},[51015]={2159,2156},[51036]=2157,[51037]=2157,[51038]=2157,[51039]=2157,[51040]=2157,[51041]=2157,[51042]=2157,[51043]=2157,[51044]=2157,[51045]=2157,[51046]=2157,[51047]=2157,[51048]=2157,[51049]=2157,[51050]=2157,[51051]=2157,[51173]={2159,2158},[51174]={2159,2158},[51181]={2159,2158},[51198]={2159,2158},[51210]={2159,2158},[51223]={2159,2158},[51228]={2159,2158},[51232]={2159,2103},[51238]={2159,2158},[51239]={2159,2158},[51250]={2159,2158},[51252]={2159,2158},[51285]={2159,2158},[51316]={2159,2158},[51322]={2159,2158},[51330]={2159,2158},[51462]={2160,2157},[51463]={2160,2157},[51475]={2159,2103},[51494]={2159,2103},[51495]={2159,2103},[51496]={2159,2103},[51497]={2159,2103},[51558]={2159,2158},[51559]={2159,2158},[51578]={2160,2157},[51580]={2160,2157},[51622]={2160,2157},[51646]={2160,2157},[51647]={2160,2157},[51671]={2160,2157},[51719]={2161,2157},[51727]={2161,2157},[51737]={2161,2157},[51738]={2161,2157},[51739]={2161,2157},[51740]={2161,2157},[51741]={2161,2157},[51743]={2161,2157},[51745]={2161,2157},[51746]={2161,2157},[51747]={2161,2157},[51754]={2161,2157},[51761]={2161,2157},[51763]={2159,2158},[51764]={2161,2157},[51765]={2161,2157},[51767]={2161,2157},[51768]={2161,2157},[51769]={2161,2157},[51780]={2159,2158},[51791]={2159,2158},[51792]={2159,2158},[51811]={2162,2157},[51827]={2162,2157},[51828]={2162,2157},[51832]={2161,2157},[51840]={2162,2157},[51850]={2159,2158},[51957]={2159,2158},[51983]={2159,2158},[51996]={2162,2157},[51997]={2159,2158},[52004]={2162,2157},[52006]={2159,2156},[52007]={2159,2156},[52056]={2160,2157},[52057]={2160,2157},[52063]={2162,2157},[52064]={2162,2157},[52115]={2162,2157},[52117]={2162,2157},[52119]={2160,2157},[52124]={2160,2157},[52160]={2162,2157},[52209]={2162,2157},[52229]={2162,2157},[52236]={2162,2157},[52239]={2162,2157},[52248]={2159,2103},[52280]={2162,2157},[52335]=2157,[52336]={2159,2103},[52337]={2159,2156},[52341]=2157,[52342]=2157,[52358]={2159,2103},[52359]={2159,2103},[52361]={2159,2156},[52362]={2159,2158},[52369]=2157,[52372]={2159,2156},[52373]={2159,2103},[52374]=2157,[52382]=2157,[52384]=2157,[52385]={2159,2156},[52387]=2157,[52388]=2157,[52395]={2159,2103},[52396]={2159,2156},[52397]={2159,2158},[52398]=2157,[52409]={2159,2103},[52410]={2159,2156},[52412]={2159,2158},[52418]={2159,2156},[52420]={2159,2103},[52421]={2159,2103},[52425]={2159,2103},[52426]={2159,2156},[52752]={2160,2157},[52755]={2160,2157},[52756]={2160,2157},[52757]={2160,2157},[52760]={2160,2157},[52763]={2160,2157},[52798]={2159,2158},[52804]={2160,2157},[52805]={2160,2157},[52848]={2161,2157},[52882]={2162,2157},[52890]=67,[52936]={2162,2157},[52940]={2162,2157},[52968]={2162,2157},[52986]={2162,2157},[53008]={2162,2157},[53042]={2162,2157},[53076]={2160,2157},[53078]={2160,2157},[53196]={2160,2157},[53343]={2162,2157},[53344]={2162,2157},[53345]={2162,2157},[52345]=2163,[52346]=2163,[52348]=2163,[52349]=2163,[52350]=2163,[52351]=2163,[52393]=2163,[50487]=2156,[50502]={2159,2156},[50506]=2156,[50511]={2159,2156},[50516]={2159,2156},[50570]={2159,2156},[50667]={2159,2156},[50747]={2159,2103},[50872]={2159,2103},[50981]={2162,2157},[50992]={2160,2157},[51014]={2159,2103},[51090]={2160,2157},[51105]={2159,2158},[51107]={2159,2158},[51124]=2158,[51125]=2158,[51176]={2159,2156},[51180]={2159,2158},[51296]={2160,2157},[51379]={2159,2158},[51455]={2162,2157},[51461]={2161,2157},[51502]={2159,2103},[51561]={2159,2158},[51616]=2161,[51652]={2160,2157},[51660]={2160,2157},[51742]={2161,2157},[51900]={2159,2158},[51919]={2161,2157},[51924]={2159,2158},[51977]={2162,2157},[51978]={2162,2157},[51982]={2162,2157},[52133]={2162,2157},[52198]={2162,2157},[52199]=2162,[52237]={2161,2157},[52238]={2161,2157},[52251]={2159,2103},[52315]={2162,2157},[52332]={2162,2157},[52338]={2159,2158},[52355]={2160,2157},[52360]={2159,2156},[52381]={2161,2157},[52383]={2159,2103},[52386]={2159,2158},[52404]={2160,2157},[52406]={2161,2157},[52408]={2159,2103},[52416]={2160,2157},[52432]=2162,[52454]={2160,2157},[52456]={2160,2157},[52507]={2162,2157},[52771]={2160,2157},[52775]={2161,2157},[52808]={2164,2159,2156},[52885]=469,[53025]={2162,2157},[53282]={2160,2157},[53321]={2159,2156},[51012]={2159,2156},[52364]={2161,2157}}

local invtype_locations = {
	INVTYPE_HEAD = { INVSLOT_HEAD },
	INVTYPE_NECK = { INVSLOT_NECK },
	INVTYPE_SHOULDER = { INVSLOT_SHOULDER },
	INVTYPE_BODY = { INVSLOT_BODY },
	INVTYPE_CHEST = { INVSLOT_CHEST },
	INVTYPE_ROBE = { INVSLOT_CHEST },
	INVTYPE_WAIST = { INVSLOT_WAIST },
	INVTYPE_LEGS = { INVSLOT_LEGS },
	INVTYPE_FEET = { INVSLOT_FEET },
	INVTYPE_WRIST = { INVSLOT_WRIST },
	INVTYPE_HAND = { INVSLOT_HAND },
	INVTYPE_FINGER = { INVSLOT_FINGER1, INVSLOT_FINGER2 },
	INVTYPE_TRINKET = { INVSLOT_TRINKET1, INVSLOT_TRINKET2 },
	INVTYPE_CLOAK = { INVSLOT_BACK },
	INVTYPE_WEAPON = { INVSLOT_MAINHAND, INVSLOT_OFFHAND },
	INVTYPE_SHIELD = { INVSLOT_OFFHAND },
	INVTYPE_2HWEAPON = { INVSLOT_MAINHAND },
	INVTYPE_WEAPONMAINHAND = { INVSLOT_MAINHAND },
	INVTYPE_WEAPONOFFHAND = { INVSLOT_OFFHAND },
	INVTYPE_HOLDABLE = { INVSLOT_OFFHAND },
}

function Data:QuestHasFaction(questID, factionID)
	local reps = worldQuestReps[questID]
	if reps then
		if (type(reps) == "table") then
			for _, fID in ipairs(reps) do
				if fID == factionID then return true end
			end
			return false
		else
			return reps == factionID
		end
	else
		return false
	end
end

function Data:RewardIsUpgrade(itemID, questID)
	local equipSlot = select(4, C_Item.GetItemInfoInstant(itemID))
	local ilvl = self:RewardItemLevel(itemID, questID)

	if equipSlot and invtype_locations[equipSlot] then
		local isUpgrade = false

		for _, slotID in ipairs(invtype_locations[equipSlot]) do
			local currentItem = ItemLocation:CreateFromEquipmentSlot(slotID)
			if currentItem:IsValid() then
				local currentIlvl = C_Item.GetCurrentItemLevel(currentItem)
				if not currentIlvl or ilvl >= (currentIlvl - Addon.Config.lootUpgradesLevel) then
					isUpgrade = true
				end
			else
				isUpgrade = true
			end
		end

		return isUpgrade
	else
		return true
	end
end

function Data:RewardItemLevel(itemID, questID)
	local key = itemID..":"..questID
	if cachedItems[key] == nil then
		local invType = C_Item.GetItemInventoryTypeByID(itemID)
		local _, _, _, itemEquipLoc, _, itemClassID, itemSubClassID = C_Item.GetItemInfoInstant(itemID)
		if invType == Enum.InventoryType.IndexNonEquipType and (itemClassID ~= Enum.ItemClass.Gem or itemSubClassID ~= Enum.ItemGemSubclass.Artifactrelic) then
			cachedItems[key] = false
			return false
		end

		local itemLink = GetQuestLogItemLink("reward", 1, questID)
		cachedItems[key] = C_Item.GetDetailedItemLevelInfo(itemLink)
	end
	return cachedItems[key]
end

function Data:UNIT_QUEST_LOG_CHANGED(arg1)
	if arg1 == "player" then
		wipe(cachedItems)
	end
end
function Data:PLAYER_ENTERING_WORLD()
	wipe(cachedItems)
end

function Data:Startup()
	self:RegisterEvent('UNIT_QUEST_LOG_CHANGED')
	self:RegisterEvent('PLAYER_ENTERING_WORLD')
end
